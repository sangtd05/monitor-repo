# PHÃ‚N TÃCH Váº¤N Äá»€ VÃ€ Lá»°A CHá»ŒN GIáº¢I PHÃP (UPDATED)

> **TÃ i liá»‡u nÃ y phÃ¢n tÃ­ch bÃ i toÃ¡n monitoring thá»±c táº¿, so sÃ¡nh cÃ¡c giáº£i phÃ¡p vÃ  lÃ½ giáº£i kiáº¿n trÃºc LGTM Stack + Grafana Alloy hiá»‡n táº¡i.**

## ğŸ“‹ Má»¥c lá»¥c

- [1. Bá»‘i cáº£nh vÃ  Váº¥n Ä‘á»](#1-bá»‘i-cáº£nh-vÃ -váº¥n-Ä‘á»)
- [2. YÃªu cáº§u Há»‡ thá»‘ng](#2-yÃªu-cáº§u-há»‡-thá»‘ng)
- [3. So sÃ¡nh Giáº£i phÃ¡p](#3-so-sÃ¡nh-giáº£i-phÃ¡p)
- [4. Kiáº¿n trÃºc ÄÆ°á»£c Lá»±a chá»n (Final Decision)](#4-kiáº¿n-trÃºc-Ä‘Æ°á»£c-lá»±a-chá»n-final-decision)
- [5. Roadmap Triá»ƒn khai](#5-roadmap-triá»ƒn-khai)

---

## 1. Bá»‘i cáº£nh vÃ  Váº¥n Ä‘á»

### 1.1. Hiá»‡n tráº¡ng Háº¡ táº§ng
- **Quy mÃ´**: 31+ Servers (Váº­t lÃ½ & Virtual).
- **MÃ´i trÆ°á»ng**: Production, Staging, Dev.
- **Tech Stack**:
    - App: NestJS, Node.js.
    - DB: MongoDB, PostgreSQL.
    - Proxy: Nginx.
    - Container: Docker & Docker Compose.

### 1.2. Pain Points (Ná»—i Ä‘au hiá»‡n táº¡i)

1.  **MÃ¹ thÃ´ng tin (Zero Visibility)**:
    - KhÃ´ng biáº¿t server nÃ o CPU cao, RAM Ä‘áº§y cho Ä‘áº¿n khi sáº­p.
    - KhÃ´ng giÃ¡m sÃ¡t Ä‘Æ°á»£c database connection pool, slow query.

2.  **KhÃ³ Troubleshooting**:
    - Khi cÃ³ lá»—i, DevOps pháº£i SSH vÃ o tá»«ng server â†’ `tail -f` log.
    - Máº¥t trung bÃ¬nh 2-4 giá» Ä‘á»ƒ tÃ¬m ra nguyÃªn nhÃ¢n (MTTR cao).

3.  **Rá»i ráº¡c (Silos)**:
    - Metrics (CPU) náº±m á»Ÿ má»™t nÆ¡i.
    - Logs náº±m trÃªn file text á»Ÿ server khÃ¡c.
    - KhÃ´ng liÃªn káº¿t Ä‘Æ°á»£c: "LÃºc CPU tÄƒng cao thÃ¬ log Ä‘ang bÃ¡o lá»—i gÃ¬?".

---

## 2. YÃªu cáº§u Há»‡ thá»‘ng

### 2.1. YÃªu cáº§u Chá»©c nÄƒng (Functional)
| Req ID | MÃ´ táº£ | Má»©c Ä‘á»™ |
|--------|-------|--------|
| **FR-01** | **Unified Agent**: Chá»‰ cháº¡y 1 agent duy nháº¥t trÃªn server Ä‘á»ƒ tiáº¿t kiá»‡m resource. | Critical |
| **FR-02** | **Centralized Logging**: Gom logs tá»« 31 server vá» 1 chá»—. | Critical |
| **FR-03** | **Long-term Storage**: LÆ°u metrics > 1 nÄƒm Ä‘á»ƒ bÃ¡o cÃ¡o xu hÆ°á»›ng. | High |
| **FR-04** | **Correlation**: Nháº£y tá»« Metrics â†’ Traces â†’ Logs mÆ°á»£t mÃ . | High |
| **FR-05** | **Alerting**: BÃ¡o qua Telegram ngay khi cÃ³ sá»± cá»‘. | Critical |

### 2.2. YÃªu cáº§u Phi chá»©c nÄƒng (Non-functional)
- **Chi phÃ­**: Tá»‘i Æ°u (Æ°u tiÃªn Open Source), trÃ¡nh Vendor Lock-in (Datadog).
- **Performance**: Agent tiÃªu tá»‘n < 2% CPU, < 200MB RAM.
- **High Availability**: KhÃ´ng máº¥t dá»¯ liá»‡u khi network cháº­p chá»n (cáº§n cÆ¡ cháº¿ Buffer/Retry).

---

## 3. So sÃ¡nh Giáº£i phÃ¡p

ChÃºng ta Ä‘Ã£ cÃ¢n nháº¯c 3 hÆ°á»›ng Ä‘i chÃ­nh:

### Option 1: ELK Stack (Legacy)
*   **Gá»“m**: Elasticsearch, Logstash, Kibana.
*   **ÄÃ¡nh giÃ¡**:
    *   âŒ **Náº·ng ná»**: Elasticsearch tá»‘n quÃ¡ nhiá»u RAM (Java heap).
    *   âŒ **Chi phÃ­ lÆ°u trá»¯ cao**: Index full-text content cá»§a log.
    *   âŒ **ChuyÃªn vá» Log**: Kháº£ nÄƒng xá»­ lÃ½ Metrics/Traces yáº¿u hÆ¡n.

### Option 2: SaaS (Datadog/NewRelic)
*   **ÄÃ¡nh giÃ¡**:
    *   âœ… **Nhanh gá»n**: CÃ i agent lÃ  xong.
    *   âŒ **QuÃ¡ Ä‘áº¯t**: Vá»›i 31 servers, chi phÃ­ ~ $15,000/nÄƒm.
    *   âŒ **Metrics Custom**: Bá»‹ tÃ­nh tiá»n thÃªm trÃªn tá»«ng metric.

### Option 3: LGTM Stack (Proposed)
*   **Gá»“m**: Loki, Grafana, Tempo, Mimir.
*   **ÄÃ¡nh giÃ¡**:
    *   âœ… **Tá»‘i Æ°u chi phÃ­**: Loki khÃ´ng index full text -> Storage ráº» hÆ¡n ELK 10 láº§n.
    *   âœ… **Unified**: Grafana hiá»ƒn thá»‹ cáº£ 3 trá»¥ cá»™t (M-L-T).
    *   âœ… **Grafana Alloy**: Agent tháº¿ há»‡ má»›i, thay tháº¿ cáº£ Promtail vÃ  OTel Collector.
    *   âœ… **Mimir**: Giáº£i quyáº¿t bÃ i toÃ¡n lÆ°u trá»¯ lÃ¢u dÃ i (Long-term) mÃ  Prometheus native khÃ´ng lÃ m tá»‘t.

ğŸ‘‰ **Quyáº¿t Ä‘á»‹nh: Chá»n Option 3 (LGTM Stack)**.

---

## 4. Kiáº¿n trÃºc ÄÆ°á»£c Lá»±a chá»n (Final Decision)

Há»‡ thá»‘ng giÃ¡m sÃ¡t sáº½ Ä‘Æ°á»£c triá»ƒn khai theo mÃ´ hÃ¬nh **Pull-Push Hybrid** vá»›i **Grafana Alloy** lÃ m trung tÃ¢m.

### 4.1. SÆ¡ Ä‘á»“ Kiáº¿n trÃºc

```mermaid
graph TB
    classDef monitored fill:#e1f5ff,stroke:#0277bd,stroke-width:2px,rx:5,ry:5
    classDef central fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,rx:5,ry:5
    classDef alloy fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,rx:5,ry:5
    classDef storage fill:#eceff1,stroke:#455a64,stroke-width:2px,rx:5,ry:5
    classDef ui fill:#e0f2f1,stroke:#00695c,stroke-width:2px,rx:5,ry:5
    classDef component fill:#ffffff,stroke:#333,stroke-width:1px,rx:3,ry:3

    subgraph "Monitored Server (x31)"
        App[App Services]:::monitored
        DB[Database]:::monitored
        OS[OS Metrics]:::monitored
        
        Alloy[ğŸ”¥ Grafana Alloy Agent]:::alloy
        
        App -->|OTLP Traces/Metrics| Alloy
        DB -->|Logs/Metrics| Alloy
        OS -->|Node Exporter| Alloy
    end

    subgraph "Monitoring Server (Central)"
        Gateway[Alloy Gateway]:::alloy
        
        Prom[ğŸ¦ Prometheus]:::component
        Mimir[ğŸ™ Mimir]:::component
        Loki[Logs - Loki]:::component
        Tempo[Traces - Tempo]:::component
        MinIO[ğŸ’¾ MinIO Storage]:::storage
        
        Alloy -->|Remote Write| Prom
        Prom -->|Remote Write| Mimir
        Alloy -->|Loki Push| Loki
        Alloy -->|OTLP| Tempo
        
        Mimir --> MinIO
        Loki --> MinIO
        Tempo --> MinIO
        
        Grafana[ğŸ“ˆ Grafana UI]:::ui --> Prom & Mimir & Loki & Tempo
    end
```

### 4.2. CÃ¡c thÃ nh pháº§n máº¥u chá»‘t

1.  **Collector: Grafana Alloy** (Thay tháº¿ Promtail + OTel Collector)
    - **Vai trÃ²**: "Swiss Army Knife" of observability.
    - **Lá»£i Ã­ch**:
        - Äá»c Docker Logs, System Logs.
        - Nháº­n OTLP Traces tá»« App.
        - Scrape Metrics tá»« Exporter.
        - Xá»­ lÃ½ (Filter, Relabel, Batch) táº¡i nguá»“n trÆ°á»›c khi gá»­i Ä‘i.

2.  **Long-term Storage: Mimir**
    - Prometheus thÃ´ng thÆ°á»ng chá»‰ giá»¯ data 15 ngÃ y.
    - Mimir + MinIO (S3) giÃºp lÆ°u data **390 ngÃ y** (hoáº·c vÄ©nh viá»…n) vá»›i chi phÃ­ ráº».

3.  **Storage Backend: MinIO**
    - Táº­n dá»¥ng Object Storage cho cáº£ Loki, Tempo, Mimir.
    - Dá»… dÃ ng backup/restore vÃ  má»Ÿ rá»™ng dung lÆ°á»£ng giÃ¡ ráº».

---

## 5. Roadmap Triá»ƒn khai

### Phase 1: Core Foundation (Done)
- [x] Dá»±ng Monitoring Server (Docker Compose).
- [x] Cáº¥u hÃ¬nh MinIO, Mimir, Loki, Tempo.
- [x] Setup Grafana Dashboard cÆ¡ báº£n.

### Phase 2: Agent Rollout (Current)
- [ ] CÃ i Ä‘áº·t Grafana Alloy lÃªn cÃ¡c server vá»‡ tinh.
- [ ] Cáº¥u hÃ¬nh Alloy Ä‘á»ƒ scrape Node Exporter & Docker Logs.
- [ ] Apply "Blackbox Exporter" Ä‘á»ƒ check uptime cÃ¡c web public.

### Phase 3: Application Instrumentation (Next)
- [ ] TÃ­ch há»£p thÆ° viá»‡n OpenTelemetry vÃ o NestJS App.
- [ ] Cáº¥u hÃ¬nh App Ä‘áº©y logs dáº¡ng JSON Ä‘á»ƒ Alloy parse tá»‘t hÆ¡n.
- [ ] Setup Alert Rules cho Business Metrics (Error Rate > 1%, High Latency).

### Phase 4: Advanced & Optimization
- [ ] Tuning Retention Policy (Log giá»¯ 30 ngÃ y, Metrics giá»¯ 1 nÄƒm).
- [ ] Setup Service Graph trong Tempo.
- [ ] Training team cÃ¡ch dÃ¹ng LogQL/TraceQL.

---

## 6. Káº¿t luáº­n

Giáº£i phÃ¡p **LGTM Stack + Grafana Alloy** giáº£i quyáº¿t triá»‡t Ä‘á»ƒ cÃ¡c bÃ i toÃ¡n:
1.  **Chi phÃ­**: Táº­n dá»¥ng Open Source vÃ  MinIO Ä‘á»ƒ giáº£m chi phÃ­ lÆ°u trá»¯.
2.  **Váº­n hÃ nh**: Alloy Ä‘Æ¡n giáº£n hÃ³a viá»‡c quáº£n lÃ½ agent (1 binary duy nháº¥t).
3.  **Má»Ÿ rá»™ng**: Kiáº¿n trÃºc tÃ¡ch rá»i Storage (MinIO) vÃ  Compute (Mimir/Loki) giÃºp dá»… dÃ ng scale khi sá»‘ lÆ°á»£ng server tÄƒng lÃªn 100+.
