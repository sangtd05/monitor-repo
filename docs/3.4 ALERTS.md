# üîî Alert Rules Documentation

T√†i li·ªáu n√†y t·ªïng h·ª£p to√†n b·ªô c√°c c·∫£nh b√°o (alerts) ƒë∆∞·ª£c c·∫•u h√¨nh trong h·ªá th·ªëng Monitoring (Prometheus & Alertmanager).

## üóÇÔ∏è Ph√¢n lo·∫°i Alerts

C√°c file alert rules n·∫±m t·∫°i `grafana-prometheus/prometheus/alerts/*.yml`. Hi·ªán c√≥ **8 nh√≥m alerts** ch√≠nh:

1.  **System/Infrastructure** (`node-exporter.yml`)
2.  **Docker Containers** (`docker.yml`)
3.  **Databases** (`postgresql.yml`, `mongodb.yml`)
4.  **Web Server** (`nginx.yml`)
5.  **Observability Stack** (`lgtm-stack.yml`, `tempo.yml`)
6.  **Uptime Checks** (`blackbox.yml`)

---

## üèóÔ∏è 1. System & Infrastructure (`node-exporter.yml`)

Nh√≥m c·∫£nh b√°o quan tr·ªçng nh·∫•t v·ªÅ t√†i nguy√™n m√°y ch·ªß.

### CPU & Load
| Alert Name | Severity | ƒêi·ªÅu ki·ªán | Duration | M√¥ t·∫£ |
|------------|----------|-----------|----------|-------|
| `HostHighCpuLoad` | **Critical** | Load Average (1m) / Cores > 1.5 | 5m | CPU b·ªã overload 150% kh·∫£ nƒÉng x·ª≠ l√Ω. |
| `HostCpuHighIowait` | Warning | CPU I/O Wait > 10% | 5m | Disk ho·∫∑c Network qu√° ch·∫≠m, CPU ph·∫£i ch·ªù. |

### Memory & Disk
| Alert Name | Severity | ƒêi·ªÅu ki·ªán | Duration | M√¥ t·∫£ |
|------------|----------|-----------|----------|-------|
| `HostOutOfMemory` | **Critical** | Mem Available < 10% | 5m | RAM s·∫Øp h·∫øt, nguy c∆° OOM Kill. |
| `HostMemoryUnderMemoryPressure` | Warning | Paging Rate > 1000/s | 2m | RAM thi·∫øu tr·∫ßm tr·ªçng, h·ªá th·ªëng ƒëang ph·∫£i swap. |
| `HostOutOfDiskSpace` | **Critical** | Disk Free < 10% | 5m | ·ªî c·ª©ng s·∫Øp ƒë·∫ßy, ch·ªâ c√≤n < 10%. |
| `HostDiskWillFillIn4Hours` | Warning | Linear prediction full in 4h | 5m | D·ª± ƒëo√°n ·ªï c·ª©ng s·∫Ω ƒë·∫ßy trong 4 gi·ªù t·ªõi. |

### Availability
| Alert Name | Severity | ƒêi·ªÅu ki·ªán | Duration | M√¥ t·∫£ |
|------------|----------|-----------|----------|-------|
| `InstanceDown` | **Critical** | `up == 0` | 5m | Server ho·∫∑c Exporter ƒë√£ ch·∫øt. |
| `HostRebooted` | Info | Uptime < 10m | 0m | Server v·ª´a m·ªõi kh·ªüi ƒë·ªông l·∫°i. |

---

## üê≥ 2. Docker Containers (`docker.yml`)

| Alert Name | Severity | ƒêi·ªÅu ki·ªán | Duration | M√¥ t·∫£ |
|------------|----------|-----------|----------|-------|
| `ContainerKilled` | Warning | Exit Code = 137 | 0m | Container b·ªã Killed (th∆∞·ªùng do OOM). |
| `ContainerCpuUsage` | Warning | CPU Usage > 80% | 5m | Container d√πng qu√° nhi·ªÅu CPU. |
| `ContainerMemoryUsage` | Warning | Mem Usage > 80% | 5m | Container s·∫Øp h·∫øt RAM limit. |

---

## üóÑÔ∏è 3. Databases

### PostgreSQL (`postgresql.yml`)
| Alert Name | Severity | ƒêi·ªÅu ki·ªán | Duration | M√¥ t·∫£ |
|------------|----------|-----------|----------|-------|
| `PostgresqlDown` | **Critical** | `pg_up == 0` | 5m | Postgres service down. |
| `PostgresqlHighRollbackRate` | Warning | Rollback Rate > 0.05 | 5m | Qu√° nhi·ªÅu transactions b·ªã rollback (> 5%). |
| `PostgresqlActiveLock` | Critical | Lock Count > 5 | 5m | C√≥ > 5 queries ƒëang b·ªã lock. |
| `PostgresqlSlowQuery` | Info | Duration > 3s | 1m | Query ch·∫°y l√¢u h∆°n 3 gi√¢y. |

### MongoDB (`mongodb.yml`)
| Alert Name | Severity | ƒêi·ªÅu ki·ªán | Duration | M√¥ t·∫£ |
|------------|----------|-----------|----------|-------|
| `MongodbDown` | **Critical** | `mongodb_up == 0` | 5m | MongoDB service down. |
| `MongodbReplicationLag` | Critical | Lag > 30s | 5m | Replica Set b·ªã lag qu√° 30 gi√¢y. |
| `MongodbTooManyConnections` | Warning | Conns > 80% total | 5m | Connection pool s·∫Øp ƒë·∫ßy. |

---

## üåê 4. Web Server (`nginx.yml`)

Gi√°m s√°t Nginx Web Server th√¥ng qua `nginx-prometheus-exporter`.

| Alert Name | Severity | ƒêi·ªÅu ki·ªán | Duration | M√¥ t·∫£ |
|------------|----------|-----------|----------|-------|
| `NginxHighHttp4xxErrorRate` | **Critical** | Error Rate > 5% | 1m | T·ª∑ l·ªá l·ªói 4xx (Client Error) v∆∞·ª£t qu√° 5%. |
| `NginxHighHttp5xxErrorRate` | **Critical** | Error Rate > 5% | 1m | T·ª∑ l·ªá l·ªói 5xx (Server Error) v∆∞·ª£t qu√° 5%. |
| `NginxLatencyHigh` | Warning | P99 Latency > 3s | 2m | 99% requests ch·∫≠m h∆°n 3 gi√¢y. |

---

## üèóÔ∏è 5. LGTM Stack (`lgtm-stack.yml`, `tempo.yml`)

Bao g·ªìm gi√°m s√°t h·∫° t·∫ßng Monitoring (Operational) v√† ch·∫•t l∆∞·ª£ng Trace (Tracing Quality).

### Operational (Infrastructure)
| Component | Alert Name | Severity | M√¥ t·∫£ |
|-----------|------------|----------|-------|
| **Loki** | `LokiRequestErrors` | Critical | L·ªói ghi logs v√†o Loki (> 5%). |
| **Loki** | `LokiPanics` | Critical | Loki instance b·ªã panic/crash. |
| **Prometheus** | `PrometheusJobMissing` | Critical | Scrape job kh√¥ng t√¨m th·∫•y target n√†o. |
| **Grafana Alloy**| `AlloyDown` | **Critical**| Alloy Agent ch·∫øt, m·∫•t to√†n b·ªô data logs/trace. |
| **MinIO** | `MinioDiskSpaceUsage` | Warning | Dung l∆∞·ª£ng MinIO (Loki/Tempo storage) s·∫Øp ƒë·∫ßy (<10%). |

### Tracing Quality (Tempo RED Metrics)
C√°c alert d·ª±a tr√™n d·ªØ li·ªáu Trace ph√¢n t√≠ch ƒë∆∞·ª£c t·ª´ ·ª©ng d·ª•ng.

| Alert Name | Severity | ƒêi·ªÅu ki·ªán | Duration | M√¥ t·∫£ |
|------------|----------|-----------|----------|-------|
| `HighServiceLatencyP95` | Warning | P95 Latency > 3s | 10m | Service ph·∫£n h·ªìi ch·∫≠m. |
| `HighServiceErrorRate` | Warning | Error Rate > 5% | 10m | Service c√≥ t·ª∑ l·ªá l·ªói cao. |
| `CriticalServiceErrorRate`| **Critical**| Error Rate > 20% | 5m | Service l·ªói nghi√™m tr·ªçng (>20%). |
| `SlowEndpointDetected` | Warning | P95 > 10s | 15m | Ph√°t hi·ªán endpoint c·ª• th·ªÉ r·∫•t ch·∫≠m. |

---

## üåç 6. Uptime Checks (`blackbox.yml`)

Gi√°m s√°t t√≠nh s·∫µn s√†ng c·ªßa c√°c endpoint HTTP/HTTPS t·ª´ b√™n ngo√†i.

| Alert Name | Severity | ƒêi·ªÅu ki·ªán | Duration | M√¥ t·∫£ |
|------------|----------|-----------|----------|-------|
| `ServiceLivenessCheckFailed` | **Critical** | Probe Fail | 2m | Service ch·∫øt h·∫≥n, kh√¥ng ping ƒë∆∞·ª£c. |
| `ServiceReadinessCheckFailed` | Warning | Probe Fail | 5m | Service ch∆∞a s·∫µn s√†ng (Readiness check). |
| `ServiceHealthCheckSlow` | Warning | Duration > 2s | 5m | Health check response ch·∫≠m > 2s. |
| `SslCertificateWillExpireSoon`| Warning | Expire < 30 days | 10m | SSL Certificate s·∫Øp h·∫øt h·∫°n trong 30 ng√†y. |

---

## üì¨ H∆∞·ªõng d·∫´n X·ª≠ l√Ω Alert

### B∆∞·ªõc 1: X√°c nh·∫≠n m·ª©c ƒë·ªô (Severity)
1.  **Critical (üî¥):** H·ªá th·ªëng ƒëang g·∫∑p s·ª± c·ªë nghi√™m tr·ªçng (Service down, Disk full). **C·∫ßn x·ª≠ l√Ω ngay l·∫≠p t·ª©c.**
2.  **Warning (üü°):** H·ªá th·ªëng c√≥ d·∫•u hi·ªáu b·∫•t th∆∞·ªùng (High Load, High Memory). **C·∫ßn ƒëi·ªÅu tra ƒë·ªÉ tr√°nh bi·∫øn th√†nh Critical.**
3.  **Info (üîµ):** Th√¥ng tin tham kh·∫£o (Reboot, Deploy).

### B∆∞·ªõc 2: ƒêi·ªÅu tra (Troubleshooting)
1.  M·ªü **Alertmanager** (`:9093`) ƒë·ªÉ xem chi ti·∫øt alert v√† labels.
2.  M·ªü Dashboard t∆∞∆°ng ·ª©ng trong **Grafana**:
    *   `InstanceDown` ‚Üí Dashboard **Node Exporter Full**.
    *   `PostgresqlDown` ‚Üí Dashboard **PostgreSQL Overview**.
3.  Ki·ªÉm tra Logs trong **Log Viewer** dashboard.

### B∆∞·ªõc 3: Kh·∫Øc ph·ª•c (Mitigation)
*   **Disk Full:** X√≥a log c≈©, clean docker system, expand disk.
*   **High CPU:** Kill process treo, restart service.
*   **OOM:** TƒÉng RAM cho VM/Container.
