# üöÄ Grafana Loki Configuration Guide

## üìã T·ªïng quan

**Grafana Loki** l√† h·ªá th·ªëng log aggregation, ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ "log m·ªçi th·ª©" nh∆∞ Prometheus nh∆∞ng d√†nh cho logs.
*   **Kh√¥ng index full-text body**: Ch·ªâ index labels (metadata) -> R·∫ª, nhanh, l∆∞u ƒë∆∞·ª£c nhi·ªÅu.
*   **LogQL**: Ng√¥n ng·ªØ query m·∫°nh m·∫Ω t∆∞∆°ng t·ª± PromQL.

---

## ‚öôÔ∏è C·∫•u h√¨nh Ch√≠nh (`loki-config.yml`)

### 1. Storage (L∆∞u tr·ªØ S3)

Loki ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ d√πng **MinIO** (S3-compatible) cho c·∫£ Index v√† Chunks.

```yaml
common:
  storage:
    s3:
      endpoint: minio:9000
      bucketnames: loki
      access_key_id: mimir  # D√πng chung credential v·ªõi Mimir
      secret_access_key: mimir123
```

*   **Schema v13**: Format l∆∞u tr·ªØ t·ªëi ∆∞u nh·∫•t hi·ªán nay c·ªßa Loki.
*   **Compactor**: Ch·∫°y background ƒë·ªÉ g·ªôp c√°c file index nh·ªè, tƒÉng t·ªëc query.

### 2. Retention (V√≤ng ƒë·ªùi Log)

*   **Retention Period**: **720h** (30 ng√†y).
*   Logs c≈© h∆°n 30 ng√†y s·∫Ω b·ªã x√≥a t·ª± ƒë·ªông.

```yaml
limits_config:
  retention_period: 720h
compactor:
  retention_enabled: true
  delete_request_store: s3
```

Mu·ªën tƒÉng l√™n 90 ng√†y? S·ª≠a `720h` th√†nh `2160h`.

### 3. Limits
*   **Max Line Size**: 256KB (Log line qu√° d√†i s·∫Ω b·ªã c·∫Øt).
*   **Ingestion Rate**: 50MB/s (Tho·∫£i m√°i cho h·ªá th·ªëng v·ª´a v√† l·ªõn).

---

## üöÄ H∆∞·ªõng d·∫´n V·∫≠n h√†nh

### 1. LogQL Cheat Sheet (Tra c·ª©u nhanh)

**C∆° b·∫£n (Filter Labels)**
```logql
{service_name="backend"} 
{job="varlogs", level="error"}
```

**T√¨m ki·∫øm n·ªôi dung (Filter Line)**
```logql
{service_name="backend"} |= "error"           # Ch·ª©a ch·ªØ "error"
{service_name="backend"} != "debug"           # KH√îNG ch·ª©a "debug"
{service_name="backend"} |~ "error|fail"      # Regex (ch·ª©a error HO·∫∂C fail)
```

**Parse Log (JSON/Logfmt)**
```logql
# Log JSON: {"user": "sang", "status": 500}
{service_name="api"} | json | status=500
{service_name="api"} | json | user="sang"

# Log Logfmt: user=sang status=500
{service_name="api"} | logfmt | status=500
```

**Metric t·ª´ Log (Log to Metric)**
ƒê·∫øm s·ªë d√≤ng log l·ªói trong 5 ph√∫t qua:
```logql
count_over_time({service_name="backend"} |= "error" [5m])
```
T√≠nh 95th percentile latency t·ª´ log Nginx:
```logql
quantile_over_time(0.95, {job="nginx"} | json | unwrap request_time [1h])
```

### 2. X·ª≠ l√Ω s·ª± c·ªë "Loki kh√¥ng nh·∫≠n Log"
1.  **Check Alloy**: Alloy c√≥ ƒëang g·ª≠i l·ªói kh√¥ng? (`docker logs alloy`).
2.  **Check Time**: Th·ªùi gian tr√™n server v√† container c√≥ l·ªách nhau kh√¥ng? Loki reject log qu√° kh·ª© ho·∫∑c t∆∞∆°ng lai qu√° xa.
3.  **Check Labels**: Log kh√¥ng c√≥ labels s·∫Ω b·ªã drop. √çt nh·∫•t ph·∫£i c√≥ `{job="..."}`.

### 3. D·ªçn d·∫πp Storage
N·∫øu Disk MinIO ƒë·∫ßy (`minio-data`):
1.  Gi·∫£m `retention_period`.
2.  Ch·∫°y manual deletion (API Loki):
    ```bash
    curl -g -X POST 'http://localhost:3100/loki/api/v1/delete?match={job="docker"}&start=1704067200&end=1706659200'
    ```

---

## üìö T√†i li·ªáu tham kh·∫£o
*   [Loki Configuration](https://grafana.com/docs/loki/latest/configuration/)
*   [LogQL Documentation](https://grafana.com/docs/loki/latest/logql/)
