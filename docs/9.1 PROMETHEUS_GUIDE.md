# ðŸš€ Prometheus Configuration Guide

## ðŸ“‹ Tá»•ng quan

**Prometheus** Ä‘Ã³ng vai trÃ² lÃ  "Short-term Storage" vÃ  "Alerting Engine" trong há»‡ thá»‘ng LGTM stack.

*   **Scrape**: KÃ©o metrics tá»« cÃ¡c exporter vÃ  Alloy.
*   **Alert**: ÄÃ¡nh giÃ¡ rules vÃ  gá»­i cáº£nh bÃ¡o Ä‘áº¿n Alertmanager.
*   **Forward**: Äáº©y metrics sang Mimir Ä‘á»ƒ lÆ°u trá»¯ dÃ i háº¡n (Long-term).

---

## âš™ï¸ Cáº¥u hÃ¬nh ChÃ­nh (`prometheus.yml`)

### 1. Scrape Jobs (Thu tháº­p Metrics)

Prometheus Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ scrape cÃ¡c target sau:

| Job Name | Port | MÃ´ táº£ |
|----------|------|-------|
| `prometheus` | 9090 | Monitor chÃ­nh nÃ³. |
| `alertmanager` | 9093 | Monitor Alertmanager health. |
| `alloy` | 12345 | Monitor Alloy pipeline metrics. |
| `loki` | 3100 | Monitor Loki ingestion/query stats. |
| `tempo` | 3200 | Monitor Tempo traces stats. |
| `mimir` | 9009 | Monitor Mimir blocks/compactor stats. |
| `node-exporter` | 9100 | ThÃ´ng sá»‘ pháº§n cá»©ng (CPU, Disk, RAM). |

NgoÃ i ra, sá»­ dá»¥ng `file_sd_configs` (File Service Discovery) cho cÃ¡c dynamic target:
*   `node.json`, `cadvisor.json`, `nginx.json`, `mongodb.json`, `postgres.json`.
*   GiÃºp thÃªm target má»›i mÃ  khÃ´ng cáº§n restart Prometheus.

### 2. Remote Write (Gá»­i sang Mimir)

ÄÃ¢y lÃ  cáº§u ná»‘i giÃºp Prometheus trá»Ÿ thÃ nh "Stateless" (khÃ´ng sá»£ máº¥t dá»¯ liá»‡u khi restart container).

```yaml
remote_write:
  - url: http://mimir:9009/api/v1/push
    headers:
      X-Scope-OrgID: demo  # Báº¯t buá»™c cho Multi-tenancy
    queue_config:
      capacity: 10000
      max_samples_per_send: 5000
    write_relabel_configs:
      - regex: 'otel\..*'  # CÃ³ thá»ƒ drop bá»›t metrics rÃ¡c
        action: labeldrop
```

### 3. Alerting Rules

CÃ¡c rules Ä‘Æ°á»£c mount tá»« thÆ° má»¥c `/etc/prometheus/alerts/`.
*   `node-exporter.yml`: Cáº£nh bÃ¡o pháº§n cá»©ng (Disk full, High CPU).
*   `postgresql.yml` / `mongodb.yml`: Cáº£nh bÃ¡o Database.
*   `lgtm-stack.yml`: Cáº£nh bÃ¡o sá»©c khá»e cá»§a chÃ­nh há»‡ thá»‘ng Monitor.

---

## ðŸš€ HÆ°á»›ng dáº«n Váº­n hÃ nh

### 1. ThÃªm Alert Rule má»›i
1.  Táº¡o file má»›i trong thÆ° má»¥c `grafana-prometheus/prometheus/alerts/`.
2.  VÃ­ dá»¥ `myapp.yml`:
    ```yaml
    groups:
    - name: myapp
      rules:
      - alert: AppHighErrorRate
        expr: rate(http_requests_total{status="500"}[5m]) > 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "App lá»—i nhiá»u quÃ¡"
    ```
3.  Cáº­p nháº­t `prometheus.yml` á»Ÿ pháº§n `rule_files`.
4.  Reload config: `curl -X POST http://localhost:9090/-/reload`

### 2. ThÃªm Target má»›i (Server má»›i)
KhÃ´ng cáº§n sá»­a `prometheus.yml`. Chá»‰ cáº§n sá»­a JSON file trong `grafana-prometheus/prometheus/targets/`.

VÃ­ dá»¥ thÃªm Server B vÃ o `node.json`:
```json
[
  {
    "targets": ["10.0.0.1:9100"],
    "labels": {
      "env": "prod",
      "hostname": "server-a"
    }
  },
  {
    "targets": ["10.0.0.2:9100"],
    "labels": {
      "env": "prod",
      "hostname": "server-b"
    }
  }
]
```
Prometheus tá»± Ä‘á»™ng reload sau 30s.

### 3. Alertmanager (Routing)
Alertmanager (`:9093`) nháº­n cáº£nh bÃ¡o tá»« Prometheus vÃ  gá»­i Ä‘i (Telegram, Slack, Email).
*   Config táº¡i: `grafana-prometheus/alertmanager/alertmanager.yml`.
*   Kiá»ƒm tra alert Ä‘ang firing: Truy cáº­p `http://localhost:9093`.

---

## ðŸ”§ Debugging

*   **Target Down?**: VÃ o `http://localhost:9090/targets`. Náº¿u state lÃ  DOWN, xem cá»™t "Error".
*   **Metric khÃ´ng cÃ³?**: Query thá»­ trÃªn Graph cá»§a Prometheus. Náº¿u khÃ´ng tháº¥y -> Check Exporter -> Check Scrape Job.
*   **Mimir khÃ´ng nháº­n?**: Check log Prometheus: `docker logs prometheus | grep remote`.

---

## ðŸ“š TÃ i liá»‡u tham kháº£o
*   [Prometheus Configuration](https://prometheus.io/docs/prometheus/latest/configuration/configuration/)
*   [Alerting Rules](https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/)
