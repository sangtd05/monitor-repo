# ğŸš€ Alertmanager Configuration Guide

## ğŸ“‹ Tá»•ng quan

**Alertmanager** Ä‘áº£m nhiá»‡m viá»‡c xá»­ lÃ½ metrics cáº£nh bÃ¡o tá»« Prometheus:
*   **Deduplication**: Gá»™p cÃ¡c alert trÃ¹ng láº·p.
*   **Grouping**: Gom nhÃ³m alert (vd: "Cluster Down" thay vÃ¬ 100 alert "Server Down").
*   **Routing**: Gá»­i Ä‘áº¿n Ä‘Ãºng ngÆ°á»i (Email, Slack, Telegram).

---

## âš™ï¸ Cáº¥u hÃ¬nh ChÃ­nh (`alertmanager.yml`)

Trong dá»± Ã¡n nÃ y, chÃºng ta sá»­ dá»¥ng `alertmanager.yml.template` Ä‘á»ƒ inject biáº¿n mÃ´i trÆ°á»ng (Telegram Token) lÃºc khá»Ÿi Ä‘á»™ng.

### 1. Global & Route (Luá»“ng Ä‘i)

```yaml
route:
  group_by: ["alertname", "instance"]
  group_wait: 10s       # Chá» 10s Ä‘á»ƒ gom thÃªm alert cÃ¹ng nhÃ³m
  group_interval: 1m    # Gá»­i update sau má»—i 1 phÃºt
  repeat_interval: 1h   # Nháº¯c láº¡i alert sau 1 giá» náº¿u chÆ°a fix
  receiver: "telegram"  # Máº·c Ä‘á»‹nh gá»­i vÃ o Telegram
```

### 2. Receivers (Telegram)

Cáº¥u hÃ¬nh máº«u gá»­i tin nháº¯n Telegram HTML Ä‘áº¹p máº¯t.

```yaml
receivers:
  - name: "telegram"
    telegram_configs:
      - bot_token: "${TELEGRAM_BOT_TOKEN}"
        chat_id: ${TELEGRAM_CHAT_ID}
        parse_mode: "HTML"
        message: |
          {{ define "__alert_severity" }}...{{ end }}
          {{ template "__alert_severity" .Labels.severity }} <b>{{ .Labels.alertname }}</b>
          ...
```

**CÃ¡c biáº¿n mÃ´i trÆ°á»ng cáº§n set trong `docker-compose.yml`:**
*   `TELEGRAM_BOT_TOKEN`: Token láº¥y tá»« @BotFather.
*   `TELEGRAM_CHAT_ID`: ID cá»§a Group chat.

### 3. Inhibit Rules (Luáº­t á»©c cháº¿)
NgÄƒn cháº·n "bÃ£o alert" (Alert Storm).

```yaml
inhibit_rules:
  - source_match:
      severity: "critical"
    target_match:
      severity: "warning"
    equal: ["alertname", "instance"]
```
**Ã nghÄ©a**: Náº¿u Ä‘Ã£ cÃ³ alert **Critical** cho má»™t server, thÃ¬ Ä‘á»«ng gá»­i thÃªm alert **Warning** cho cÃ¹ng server Ä‘Ã³ ná»¯a (Ä‘á»¡ spam).

---

## ğŸš€ HÆ°á»›ng dáº«n Váº­n hÃ nh

### 1. Silences (Táº¯t alert táº¡m thá»i)
Khi báº£o trÃ¬ server, báº¡n khÃ´ng muá»‘n Ä‘iá»‡n thoáº¡i rung liÃªn tá»¥c? -> Táº¡o Silence.

1.  Truy cáº­p UI: `http://localhost:9093`.
2.  Báº¥m vÃ o icon "Silence" (cÃ¡i loa gáº¡ch chÃ©o) cáº¡nh alert.
3.  Chá»n thá»i gian (vd: 2 hours).
4.  Nháº­p lÃ½ do & Author.
5.  Create.

### 2. ThÃªm kÃªnh nháº­n tin má»›i (vd: Slack)
1.  Sá»­a `alertmanager.yml.template`.
2.  ThÃªm receiver `slack`:
    ```yaml
    receivers:
    - name: 'slack'
      slack_configs:
      - api_url: 'https://hooks.slack.com/services/...'
        channel: '#ops'
    ```
3.  Sá»­a `route` Ä‘á»ƒ trá» vá» `slack` (hoáº·c dÃ¹ng `routes` con Ä‘á»ƒ Ä‘á»‹nh tuyáº¿n theo severity).

### 3. Test Alert
Äá»ƒ test xem Telegram cÃ³ hoáº¡t Ä‘á»™ng khÃ´ng:
1.  Táº¡o má»™t alert test trong Prometheus (`vector(1)`).
2.  Hoáº·c táº¯t thá»­ má»™t exporter Ä‘á»ƒ trigger `InstanceDown`.

---

## ğŸ“š TÃ i liá»‡u tham kháº£o
*   [Alertmanager Configuration](https://prometheus.io/docs/alerting/latest/configuration/)
*   [Notification Template Reference](https://prometheus.io/docs/alerting/latest/notifications/)
