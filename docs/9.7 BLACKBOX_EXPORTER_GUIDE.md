# üöÄ Blackbox Exporter Configuration Guide

## üìã T·ªïng quan

**Blackbox Exporter** cho ph√©p "gi√°m s√°t h·ªôp ƒëen" (Blackbox Monitoring) c√°c endpoint t·ª´ b√™n ngo√†i.
*   **Kh√¥ng c·∫ßn c√†i agent** l√™n server ƒë√≠ch.
*   Ki·ªÉm tra: HTTP, HTTPS, DNS, TCP, ICMP.
*   Tr·∫£ l·ªùi c√¢u h·ªèi: "User c√≥ truy c·∫≠p ƒë∆∞·ª£c web kh√¥ng?", "Certificate c√≤n h·∫°n kh√¥ng?".

---

## ‚öôÔ∏è C·∫•u h√¨nh Ch√≠nh (`blackbox.yml`)

### 1. Modules

Blackbox Exporter ƒë·ªãnh nghƒ©a c√°c **modules** (k·ªãch b·∫£n ki·ªÉm tra).

| Module | Prober | M√¥ t·∫£ |
|--------|--------|-------|
| `http_2xx` | http | Ki·ªÉm tra HTTP GET tr·∫£ v·ªÅ status 200-299. |
| `http_liveness` | http | Ki·ªÉm tra Liveness Probe (th∆∞·ªùng d√πng cho K8s/Docker). |
| `http_readiness` | http | Ki·ªÉm tra Readiness Probe. |
| `tcp_connect` | tcp | Ki·ªÉm tra k·∫øt n·ªëi TCP (SSH, Redis, DB). |
| `icmp` | icmp | Ping server (check network connectivity). |

**V√≠ d·ª• c·∫•u h√¨nh Module `http_2xx`:**
```yaml
modules:
  http_2xx:
    prober: http
    timeout: 5s
    http:
      valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
      valid_status_codes: [200]
      method: GET
      preferred_ip_protocol: "ip4"
```

### 2. Prometheus Job

ƒê·ªÉ s·ª≠ d·ª•ng Blackbox Exporter, ta c·∫ßn c·∫•u h√¨nh Prometheus Scrape Job (`prometheus.yml`).

**C∆° ch·∫ø Relabeling:**
1.  Target th·∫≠t (`http://google.com`) ƒë∆∞·ª£c ƒë·ªÉ trong params.
2.  Target c·ªßa Prometheus tr·ªè v·ªÅ `blackbox-exporter:9115`.
3.  D√πng `relabel_configs` ƒë·ªÉ tr√°o ƒë·ªïi params.

```yaml
- job_name: 'blackbox-http-readiness'
  metrics_path: /probe
  params:
    module: [http_readiness]  # T√™n module trong blackbox.yml
  file_sd_configs:
    - files:
        - /etc/prometheus/targets/blackbox-readiness.json
```

---

## üöÄ H∆∞·ªõng d·∫´n V·∫≠n h√†nh

### 1. Th√™m Web c·∫ßn monitor
Kh√¥ng c·∫ßn s·ª≠a `blackbox.yml` hay `prometheus.yml`. Ch·ªâ c·∫ßn th√™m v√†o file JSON targets.

**File:** `grafana-prometheus/prometheus/targets/blackbox-readiness.json`
```json
[
  {
    "targets": [
      "https://google.com",
      "https://my-api.com/health"
    ],
    "labels": {
      "env": "production"
    }
  }
]
```

### 2. Debugging
N·∫øu monitor b√°o l·ªói (Probe Failed), b·∫°n c√≥ th·ªÉ debug th·ªß c√¥ng b·∫±ng `curl`:

```bash
# Debug module http_2xx v·ªõi target google.com
curl "http://localhost:9115/probe?module=http_2xx&target=https://google.com"
```
K·∫øt qu·∫£ tr·∫£ v·ªÅ s·∫Ω l√† metrics chi ti·∫øt:
*   `probe_success 1`: Th√†nh c√¥ng.
*   `probe_http_status_code`: M√£ l·ªói (vd: 503).
*   `probe_duration_seconds`: Th·ªùi gian ph·∫£n h·ªìi.
*   `probe_ssl_earliest_cert_expiry`: Th·ªùi gian h·∫øt h·∫°n SSL.

### 3. Monitor SSL/TLS
Blackbox Exporter t·ª± ƒë·ªông thu th·∫≠p th√¥ng tin SSL.
*   **Alert Certificate s·∫Øp h·∫øt h·∫°n (< 30 ng√†y):**
    ```promql
    (probe_ssl_earliest_cert_expiry - time()) < 3600 * 24 * 30
    ```

---

## üìö T√†i li·ªáu tham kh·∫£o
*   [Blackbox Exporter Config](https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md)
*   [Example Configuration](https://github.com/prometheus/blackbox_exporter/blob/master/example.yml)
