# ðŸš€ Grafana Alloy Configuration Guide

## ðŸ“‹ Tá»•ng quan

**Grafana Alloy** lÃ  "bá»™ nÃ£o" thu tháº­p telemetry (Metrics, Logs, Traces) cá»§a toÃ n há»‡ thá»‘ng. NÃ³ thay tháº¿ cho cÃ¡c agent rá»i ráº¡c trÆ°á»›c Ä‘Ã¢y nhÆ° Promtail vÃ  OpenTelemetry Collector.

### Táº¡i sao dÃ¹ng Alloy?
*   **Unified Agent**: Chá»‰ cáº§n cháº¡y 1 binary cho má»i loáº¡i dá»¯ liá»‡u.
*   **Pipeline Processing**: Cho phÃ©p lá»c, sá»­a Ä‘á»•i, thÃªm nhÃ£n dá»¯ liá»‡u trÆ°á»›c khi gá»­i Ä‘i.
*   **OTLP Native**: Há»— trá»£ chuáº©n OpenTelemetry.

---

## ðŸ—ï¸ Architecture Pipeline

Alloy hoáº¡t Ä‘á»™ng theo nguyÃªn táº¯c **Components Pipeline**:
`Receiver -> Processor -> Exporter`

```mermaid
graph LR
    classDef input fill:#e1f5ff,stroke:#0277bd,stroke-width:2px,rx:5,ry:5
    classDef processor fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,rx:5,ry:5
    classDef output fill:#ffebee,stroke:#c62828,stroke-width:2px,rx:5,ry:5
    classDef alloy fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,rx:5,ry:5,stroke-dasharray: 5 5

    Docker[Docker Containers]:::input -->|Discovery| Alloy
    SysLogs[System Logs]:::input -->|Local File| Alloy
    Apps[Applications]:::input -->|OTLP| Alloy
    
    subgraph "Grafana Alloy"
        Filter[Filters & Relabel]:::processor
        Batch[Batch Processor]:::processor
        Limit[Memory Limiter]:::processor
    end
    
    Alloy:::alloy --> Filter --> Batch --> Limit
    
    Limit -->|Metrics| Prom[Prometheus]:::output
    Limit -->|Logs| Loki[Loki]:::output
    Limit -->|Traces| Tempo[Tempo]:::output
```

---

## âš™ï¸ Chi tiáº¿t Cáº¥u hÃ¬nh (`config.alloy`)

File cáº¥u hÃ¬nh táº¡i `grafana-prometheus/alloy/config.alloy`. DÆ°á»›i Ä‘Ã¢y lÃ  giáº£i thÃ­ch chi tiáº¿t cÃ¡c pipeline chÃ­nh.

### 1. Docker Log Pipeline (Thay tháº¿ Promtail)

Alloy tá»± Ä‘á»™ng phÃ¡t hiá»‡n container má»›i vÃ  thu tháº­p logs.

```alloy
// 1. Discovery
discovery.docker "containers" {
  host = "unix:///var/run/docker.sock"
}

// 2. Relabeling (LÃ m sáº¡ch Labels)
discovery.relabel "docker_logs" {
  targets = discovery.docker.containers.targets
  
  // Drop logs cá»§a chÃ­nh monitoring system (trÃ¡nh loops)
  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = ".*(loki|alloy).*"
    action        = "drop"
  }
  
  // Extract Service Name tá»« Docker Labels
  rule {
    source_labels = ["__meta_docker_container_label_com_docker_compose_service"]
    target_label  = "service"
  }
}

// 3. Forward to Loki
loki.source.docker "containers" {
  targets    = discovery.relabel.docker_logs.output
  forward_to = [loki.process.docker_logs.receiver]
}
```

### 2. OTLP Pipeline (Thay tháº¿ OTel Collector)

Nháº­n data tá»« á»©ng dá»¥ng qua port 4317 (gRPC) vÃ  4318 (HTTP).

```alloy
// 1. Receiver
otelcol.receiver.otlp "default" {
  grpc { endpoint = "0.0.0.0:4317" }
  http { endpoint = "0.0.0.0:4318" }
  
  output {
    metrics = [otelcol.processor.memory_limiter.default.input]
    traces  = [otelcol.processor.memory_limiter.default.input]
    logs    = [otelcol.processor.memory_limiter.default.input]
  }
}

// 2. Processors (Báº£o vá»‡ memory & Gom Batch)
otelcol.processor.memory_limiter "default" {
  limit = "400MiB"  // Náº¿u RAM dÃ¹ng > 400MB, sáº½ drop data Ä‘á»ƒ trÃ¡nh crash
}

otelcol.processor.batch "default" {
  send_batch_size = 8192
  timeout         = "5s"
}

// 3. Exporters (Äáº©y Ä‘i Ä‘Ã¢u?)
otelcol.exporter.prometheus "otlp_metrics" {
  forward_to = [prometheus.remote_write.otlp_metrics.receiver]
}

otelcol.exporter.loki "otlp_logs" {
  forward_to = [loki.write.default.receiver]
}

otelcol.exporter.otlp "tempo" {
  client { endpoint = "tempo:4317" }
}
```

---

## ðŸ”§ HÆ°á»›ng dáº«n Váº­n hÃ nh

### 1. Debugging Pipeline
Truy cáº­p UI cá»§a Alloy Ä‘á»ƒ xem sÆ¡ Ä‘á»“ pipeline Ä‘ang cháº¡y:
*   URL: `http://localhost:12345` (xem file `docker-compose.monitor.yml` náº¿u port khÃ¡c)
*   Táº¡i Ä‘Ã¢y báº¡n cÃ³ thá»ƒ tháº¥y component nÃ o Ä‘ang errors, component nÃ o Ä‘ang dropping data.

### 2. ThÃªm target má»›i (VÃ­ dá»¥: Log file custom)
Muá»‘n Alloy Ä‘á»c thÃªm file `/var/log/myapp.log`, thÃªm Ä‘oáº¡n sau vÃ o `config.alloy`:

```alloy
local.file_match "myapp_log" {
  path_targets = [{
    __path__ = "/var/log/myapp.log",
    job      = "myapp",
  }]
}

loki.source.file "myapp" {
  targets    = local.file_match.myapp_log.targets
  forward_to = [loki.write.default.receiver]
}
```

### 3. Performance Tuning
Náº¿u Alloy chiáº¿m quÃ¡ nhiá»u CPU/RAM:
*   Giáº£m `refresh_interval` trong discovery (máº·c Ä‘á»‹nh 5s -> sá»­a thÃ nh 30s).
*   TÄƒng `spike_limit` trong memory limiter.
*   Log logic quÃ¡ phá»©c táº¡p (Regex) -> chuyá»ƒn bá»›t logic sang Loki (dÃ¹ng LogQL lÃºc query).

---

## ðŸ“š TÃ i liá»‡u tham kháº£o
*   [Alloy Standard Library](https://grafana.com/docs/alloy/latest/reference/stdlib/)
*   [Docker Discovery](https://grafana.com/docs/alloy/latest/reference/components/discovery/discovery.docker/)
*   [OTLP Receiver](https://grafana.com/docs/alloy/latest/reference/components/otelcol/otelcol.receiver.otlp/)
