# üöÄ Grafana Mimir - Long-term Metrics Storage Setup

## üìã T·ªïng quan

**Grafana Mimir** ƒë∆∞·ª£c c·∫•u h√¨nh l√†m **backend l∆∞u tr·ªØ d√†i h·∫°n (Long-term Storage)** cho Prometheus.
*   **Prometheus**: Gi·ªØ metrics ng·∫Øn h·∫°n (5 ng√†y) ƒë·ªÉ query nhanh v√† alerting.
*   **Mimir**: Gi·ªØ metrics d√†i h·∫°n (**> 1 nƒÉm**) ƒë·ªÉ b√°o c√°o, trend analysis v√† capacity planning.

---

## üèóÔ∏è Architecture & Data Flow

H·ªá th·ªëng ho·∫°t ƒë·ªông theo m√¥ h√¨nh **Hybrid Storage**:

```mermaid
graph LR
    classDef app fill:#e1f5ff,stroke:#0277bd,stroke-width:2px,rx:5,ry:5
    classDef agent fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,rx:5,ry:5
    classDef prom fill:#ffebee,stroke:#c62828,stroke-width:2px,rx:5,ry:5
    classDef mimir fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,rx:5,ry:5
    classDef storage fill:#eceff1,stroke:#455a64,stroke-width:2px,rx:5,ry:5
    classDef ui fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,rx:5,ry:5

    Apps[Applications]:::app --> Alloy[Grafana Alloy]:::agent
    Alloy -->|Remote Write| Prom[Prometheus]:::prom
    Prom -->|Remote Write| Mimir[Mimir]:::mimir
    Mimir -->|S3| MinIO[MinIO Storage]:::storage
    
    Grafana:::ui -->|Query recent <24h| Prom
    Grafana -->|Query history >24h| Mimir
```

### Configuration Highlights (Based on `mimir-config.yml`)
*   **Mode**: Monolithic (`-target=all` - ch·∫°y t·∫•t c·∫£ components trong 1 container).
*   **Storage Backend**: S3 (MinIO).
*   **Multitenancy**: Enabled (M·∫∑c ƒë·ªãnh header `X-Scope-OrgID: demo`).
*   **Replication Factor**: 1 (Single node setup).

---

## ‚öôÔ∏è Chi ti·∫øt C·∫•u h√¨nh (Deep Dive)

### 1. Storage & Retention (L∆∞u tr·ªØ)
Mimir s·ª≠ d·ª•ng **MinIO** l√†m Object Storage ƒë·ªÉ l∆∞u blocks.

*   **TSDB (Ingester)**: L∆∞u ƒë·ªám tr√™n ƒëƒ©a 24h (`/data/mimir/tsdb`).
*   **Compactor (Long-term)**: L∆∞u tr√™n S3 (MinIO) v·ªõi th·ªùi gian **390 ng√†y** (~13 th√°ng).

```yaml
# config: mimir-config.yml
blocks_storage:
  backend: s3
  s3:
    endpoint: minio:9000
    bucket_name: mimir-blocks
  tsdb:
    retention_period: 24h  # Ingester check
    
limits:
  compactor_blocks_retention_period: 390d  # Data t·ªìn t·∫°i h∆°n 1 nƒÉm
```

### 2. Limits & Quotas (Gi·ªõi h·∫°n)
ƒê·ªÉ b·∫£o v·ªá h·ªá th·ªëng kh·ªèi qu√° t·∫£i (Metric Explosion), c√°c gi·ªõi h·∫°n sau ƒë∆∞·ª£c √°p d·ª•ng:

| Parameter | Value | √ù nghƒ©a |
|-----------|-------|---------|
| `ingestion_rate` | 100,000 | T·ªëi ƒëa 100k samples/gi√¢y. |
| `max_global_series_per_user` | 1,000,000 | T·ªëi ƒëa 1 tri·ªáu active series (ƒë·ªß cho ~5000 containers). |
| `max_global_series_per_metric` | 100,000 | M·ªôt t√™n metric kh√¥ng ƒë∆∞·ª£c c√≥ qu√° 100k label combinations. |

### 3. Ports & Service Discovery
*   **HTTP Port**: `9009` (D√πng ƒë·ªÉ push metrics v√† query).
*   **Membership**: S·ª≠ d·ª•ng `memberlist` ƒë·ªÉ qu·∫£n l√Ω cluster (d√π hi·ªán t·∫°i ch·ªâ ch·∫°y 1 node).

---

## üöÄ H∆∞·ªõng d·∫´n V·∫≠n h√†nh (Operations Update)

### 1. C√°ch Query Metrics t·ª´ Mimir
Trong Grafana, b·∫°n c·∫ßn ch·ªçn Datasource l√† **Mimir** (th∆∞·ªùng ƒë·∫∑t t√™n l√† `Prometheus-Mimir`).

**Khi n√†o d√πng Mimir Datasource?**
*   Khi c·∫ßn v·∫Ω bi·ªÉu ƒë·ªì > 5 ng√†y (vd: b√°o c√°o th√°ng).
*   Khi c·∫ßn so s√°nh d·ªØ li·ªáu nƒÉm n√†y vs nƒÉm ngo√°i.

**Khi n√†o d√πng Prometheus Datasource?**
*   Debug realtime.
*   Dashboard h√†ng ng√†y (Last 24h).

### 2. Ki·ªÉm tra Health
*   **Mimir Build Info**: `http://localhost:9009/api/v1/status/buildinfo`
*   **Ready Check**: `http://localhost:9009/ready`

### 3. Multi-tenancy (Quan tr·ªçng)
V√¨ `multitenancy_enabled: true`, m·ªçi request ƒë·∫øn Mimir **B·∫ÆT BU·ªòC** ph·∫£i c√≥ header:
`X-Scope-OrgID: <tenant_id>`

Trong c·∫•u h√¨nh hi·ªán t·∫°i, Prometheus g·ª≠i remote write kh√¥ng set header n√†y th√¨ Mimir s·∫Ω reject.
*   **Prometheus Config** c·∫ßn th√™m:
    ```yaml
    remote_write:
      - url: http://mimir:9009/api/v1/push
        headers:
          X-Scope-OrgID: demo
    ```

### 4. Backup & Restore
D·ªØ li·ªáu n·∫±m ho√†n to√†n trong **MinIO Bucket** `mimir-blocks`.
*   **Backup**: D√πng `mc mirror` ƒë·ªÉ sync bucket sang cloud (AWS S3/GCS) ho·∫∑c disk kh√°c.
*   **Kh√¥ng c·∫ßn backup disk c·ªßa container Mimir** (v√¨ ƒë√≥ ch·ªâ l√† cache/tmp data).

---

## üîß Troubleshooting Common Issues

### L·ªói 1: `user=anonymous` b·ªã `401 Unauthorized` ho·∫∑c `400 Bad Request`
*   **Nguy√™n nh√¢n**: Qu√™n header `X-Scope-OrgID`.
*   **Fix**: Ki·ªÉm tra Grafana Datasource config, ph·∫ßn `Custom HTTP Headers` ph·∫£i c√≥ `X-Scope-OrgID: demo` (ho·∫∑c tenant ID kh√°c).

### L·ªói 2: Query ch·∫≠m ho·∫∑c timeout
*   **Nguy√™n nh√¢n**: Query range qu√° r·ªông (vd: `rate[1y]`) m√† kh√¥ng d√πng Recording Rules.
*   **Fix**:
    1. Gi·∫£m range query.
    2. TƒÉng timeout trong Grafana.
    3. T·∫°o Recording Rule cho c√°c query n·∫∑ng.

### L·ªói 3: `err-mimir-sample-out-of-order`
*   **Nguy√™n nh√¢n**: ƒê·∫©y metric c≈© (qu√° kh·ª©) v√†o Mimir. Mimir m·∫∑c ƒë·ªãnh ch·ªâ nh·∫≠n metric m·ªõi.
*   **Fix**: Mimir support out-of-order ingestion (c·∫ßn enable trong config n·∫øu th·ª±c s·ª± c·∫ßn backfill data).

---

## üìö T√†i li·ªáu tham kh·∫£o
*   [Mimir Configuration Reference](https://grafana.com/docs/mimir/latest/references/configuration-parameters/)
*   [MinIO Client (mc) Guide](https://min.io/docs/minio/linux/reference/minio-mc.html)
