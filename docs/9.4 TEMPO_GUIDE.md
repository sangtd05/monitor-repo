# ğŸš€ Grafana Tempo Configuration Guide

## ğŸ“‹ Tá»•ng quan

**Grafana Tempo** lÃ  há»‡ thá»‘ng Distributed Tracing backend.
*   **Trace ID**: GiÃºp báº¡n Ä‘i theo dáº¥u chÃ¢n cá»§a 1 request tá»« Frontend -> Gateway -> Backend -> Database.
*   **Cost-effective**: Chá»‰ cáº§n Object Storage (S3), khÃ´ng cáº§n Index Ä‘áº¯t tiá»n (Elasticsearch).
*   **Interoperability**: Há»— trá»£ má»i chuáº©n (OTLP, Jaeger, Zipkin).

---

## âš™ï¸ Cáº¥u hÃ¬nh ChÃ­nh (`tempo-config.yml`)

### 1. Distributors (Receivers)

Tempo nghe trÃªn nhiá»u port Ä‘á»ƒ nháº­n trace tá»« cÃ¡c thÆ° viá»‡n khÃ¡c nhau:

| Protocol | Port | MÃ´ táº£ |
|----------|------|-------|
| **OTLP gRPC** | 4317 | **Chuáº©n má»›i nháº¥t** (KhuyÃªn dÃ¹ng) |
| **OTLP HTTP** | 4318 | Cho Web/JS clients |
| Jaeger gRPC | 14250 | Legacy agents |
| Zipkin | 9411 | Legacy Java apps |

### 2. Storage (LÆ°u trá»¯ S3)

TÆ°Æ¡ng tá»± Loki/Mimir, Tempo lÆ°u data vÃ o **MinIO** bucket `tempo`.
*   **Retention**: `168h` (7 ngÃ y). Trace thÆ°á»ng chá»‰ cáº§n thiáº¿t khi debug nÃ³ng, khÃ´ng cáº§n lÆ°u quÃ¡ lÃ¢u.
*   **WAL (Write Ahead Log)**: LÆ°u táº¡m trÃªn disk `/var/tempo/wal` Ä‘á»ƒ trÃ¡nh máº¥t dá»¯ liá»‡u trÆ°á»›c khi Ä‘áº©y lÃªn S3.

### 3. Metrics Generator (TÃ­nh nÄƒng Cao cáº¥p)

ÄÃ¢y lÃ  tÃ­nh nÄƒng máº¡nh máº½ nháº¥t: **Tempo tá»± phÃ¢n tÃ­ch Trace Ä‘á»ƒ sinh ra Metrics (RED Method)**.

```yaml
metrics_generator:
  remote_write:
    - url: http://prometheus:9090/api/v1/write
      send_exemplars: true
  processor:
    service_graphs:       # Váº½ biá»ƒu Ä‘á»“ phá»¥ thuá»™c Service A -> Service B
    span_metrics:         # TÃ­nh Latency, Error Rate cho tá»«ng operation
```

**Lá»£i Ã­ch:**
*   Báº¡n khÃ´ng cáº§n code metrics thá»§ cÃ´ng trong á»©ng dá»¥ng.
*   Chá»‰ cáº§n gá»­i Trace -> Tempo sáº½ tá»± tÃ­nh: "API nÃ y Ä‘ang cháº­m bao nhiÃªu ms?", "Tá»· lá»‡ lá»—i lÃ  bao nhiÃªu?".
*   Result metrics Ä‘Æ°á»£c Ä‘áº©y ngÆ°á»£c vá» **Prometheus**.

---

## ğŸš€ HÆ°á»›ng dáº«n Váº­n hÃ nh

### 1. CÃ¡ch xem Trace trÃªn Grafana
1.  VÃ o menu **Explore**.
2.  Chá»n datasource **Tempo**.
3.  **Search**: TÃ¬m theo Service Name, Operation Name, Duration (vd: `> 500ms`).
4.  **TraceQL** (nhÆ° LogQL nhÆ°ng cho Trace):
    ```traceql
    { span.http.method = "POST" && duration > 5s }
    ```

### 2. LiÃªn káº¿t Metrics vÃ  Logs (Derived Fields)
Khi báº¡n nhÃ¬n tháº¥y má»™t vá»‡t Ä‘á» (Lá»—i) trÃªn biá»ƒu Ä‘á»“ Metrics, lÃ m sao nháº£y sang Trace?
*   ÄÃ³ lÃ  tÃ­nh nÄƒng **Exemplars** (cÃ¡c Ä‘á»‘m sÃ¡ng trÃªn biá»ƒu Ä‘á»“ Prometheus).
*   Click vÃ o Ä‘á»‘m sÃ¡ng -> Nháº£y sang Tempo Trace ID tÆ°Æ¡ng á»©ng.

Khi Ä‘ang xem Trace, lÃ m sao xem Log?
*   Äáº£m báº£o Log cá»§a báº¡n cÃ³ in ra `trace_id`.
*   Loki sáº½ tá»± Ä‘á»™ng link trace_id Ä‘Ã³ sang Tempo.

---

## ğŸ”§ Troubleshooting

### Máº¥t Trace (Missing Spans)
1.  **Check Sampling**: App cá»§a báº¡n cÃ³ Ä‘ang sample 100% khÃ´ng? Hay chá»‰ 1%?
2.  **Check Propagation**: CÃ¡c service gá»i nhau cÃ³ truyá»n header `traceparent` khÃ´ng? Náº¿u Ä‘á»©t header, trace sáº½ bá»‹ gÃ£y Ä‘oáº¡n.
3.  **Check Time**: Clock skew giá»¯a cÃ¡c server quÃ¡ lá»›n sáº½ lÃ m sai lá»‡ch thá»© tá»± span.

---

## ğŸ“š TÃ i liá»‡u tham kháº£o
*   [Tempo Configuration](https://grafana.com/docs/tempo/latest/configuration/)
*   [TraceQL](https://grafana.com/docs/tempo/latest/traceql/)
