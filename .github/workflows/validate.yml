name: Validate
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
jobs:
  validate-docker-compose:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Validate LGTM Stack Docker Compose
        run: docker compose -f lgtm-stack/docker-compose.yml config

  validate-loki-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Validate Loki Configuration
        run: |
          docker run --rm -v ${{ github.workspace }}/lgtm-stack/loki:/etc/loki \
            grafana/loki:latest -config.file=/etc/loki/loki-config.yml -verify-config

  validate-tempo-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Validate Tempo Configuration
        run: |
          set +e
          OUTPUT=$(docker run --rm -v ${{ github.workspace }}/lgtm-stack/tempo:/etc/tempo \
            grafana/tempo:latest -config.file=/etc/tempo/tempo-config.yml -target=query-frontend 2>&1)
          EXIT_CODE=$?
          set -e

          if echo "$OUTPUT" | grep -q "Starting Tempo"; then
            echo "Tempo config is valid (parsed and started successfully)"
            echo "Note: Storage connection error is expected in CI (no MinIO available)"
            exit 0
          elif echo "$OUTPUT" | grep -q "failed parsing config"; then
            echo "Tempo config parsing failed:"
            echo "$OUTPUT"
            exit 1
          else
            echo "Unexpected output:"
            echo "$OUTPUT"
            exit 1
          fi

  validate-mimir-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Validate Mimir Configuration
        run: |
          timeout 10s docker run --rm -v ${{ github.workspace }}/lgtm-stack/mimir:/etc/mimir \
            grafana/mimir:latest -config.file=/etc/mimir/mimir-config.yml -target=query-frontend || \
          if [ $? -eq 124 ]; then echo "Mimir config is valid"; else exit 1; fi

  validate-mimir-alert-rules:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Install mimirtool
        run: |
          wget https://github.com/grafana/mimir/releases/latest/download/mimirtool-linux-amd64
          chmod +x mimirtool-linux-amd64
          sudo mv mimirtool-linux-amd64 /usr/local/bin/mimirtool
      - name: Validate Mimir Alert Rules
        run: |
          for file in lgtm-stack/mimir/rules/demo/*.yml; do
            echo "Checking $file"
            mimirtool rules check "$file"
          done

  validate-alloy-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Validate Alloy Configuration
        run: |
          docker run --rm -v ${{ github.workspace }}/lgtm-stack/alloy:/etc/alloy \
            grafana/alloy:latest fmt /etc/alloy/config.alloy

  validate-grafana-dashboards:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Validate Grafana Dashboards JSON
        run: |
          for file in lgtm-stack/grafana/provisioning/dashboards/*.json; do
            echo "Validating $file"
            if ! jq empty "$file" 2>/dev/null; then
              echo "Invalid JSON in $file"
              exit 1
            fi
            echo "Valid JSON: $file"
          done
