groups:
  - name: PostgreSQLAlerts
    rules:
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL instance down on {{ $labels.instance }}"
          description: "PostgreSQL instance has been down on {{ $labels.instance }} for more than 1 minute."

      - alert: PostgreSQLHighNumberOfConnections
        expr: sum by (instance) (pg_stat_activity_count) > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High number of connections on {{ $labels.instance }}"
          description: "There are more than 100 active connections on instance {{ $labels.instance }} for the last 5 minutes."
      - alert: PostgreSQLLongRunningQueries
        expr: |
          max by (datname, usename, query, pid, state, instance) (
            pg_stat_activity_max_tx_duration{state!='idle'}
          ) > 300
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Long running query detected on {{ $labels.instance }}"
          description: |
            Query đang chạy lâu trên database:
            - Database: {{ $labels.datname }}
            - User: {{ $labels.usename }}
            - Process ID: {{ $labels.pid }}
            - Trạng thái: {{ $labels.state }}
            - Thời gian chạy: {{ $value | humanizeDuration }}
            - Query: {{ $labels.query }}
          value: "{{ $value | humanizeDuration }}"
      - alert: PostgreSQLHighReplicationLag
        expr: pg_stat_replication_lag_bytes > 100000000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High replication lag on {{ $labels.instance }}"
          description: "Replication lag is over 100MB on instance {{ $labels.instance }} for the last 5 minutes."

      - alert: PostgreSQLCheckpointsTooFrequent
        expr: rate(pg_stat_bgwriter_checkpoint_sync_time{job="postgres-exporter"}[5m]) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Checkpoints occurring too frequently on {{ $labels.instance }}"
          description: "Checkpoints are occurring more than 2 times per minute on instance {{ $labels.instance }} for the last 5 minutes."

      - alert: PostgreSQLDeadlocks
        expr: rate(pg_stat_database_deadlocks{datname!~"template.*"}[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Deadlocks detected on {{ $labels.instance }}"
          description: "There have been deadlocks on instance {{ $labels.instance }} in the last 5 minutes."
      - alert: LongRunningQuery
        expr: |
          max by (query, datname, usename, state) (
            pg_stat_activity_query_duration_seconds{job="postgres-exporter"}
          ) > 5
        for: 1m
        labels:
          severity: warning
          job: "postgres-exporter"
        annotations:
          summary: "Long Running Query detected on {{ $labels.job }}"
          description: |
            Database: {{ $labels.datname }}
            User: {{ $labels.usename }}
            State: {{ $labels.state }}
            Query duration: {{ $value | humanizeDuration }}
            Query: {{ $labels.query }}
