groups:
  - name: mongodb_slow_queries
    interval: 30s
    rules:
      - alert: MongoDBSlowQueries
        expr: |
          (
            rate(mongodb_ss_opLatencies_latency{type="commands"}[5m]) 
            / 
            rate(mongodb_ss_opLatencies_ops{type="commands"}[5m])
          ) > 100000
        for: 10m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} has slow queries"
          description: "Average query latency is {{ $value | humanize }}μs (>100ms) on {{ $labels.instance }}"

      - alert: MongoDBHighCursorTimeouts
        expr: rate(mongodb_ss_metrics_cursor_timed_out_total[5m]) > 10
        for: 5m
        labels:
          severity: critical
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} has high cursor timeouts"
          description: "{{ $value }} cursor timeouts/sec on {{ $labels.instance }}. Queries are timing out."

      - alert: MongoDBHighQueuedOperations
        expr: mongodb_mongod_global_lock_current_queue{type="total"} > 50
        for: 5m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} has queued operations"
          description: "{{ $value }} operations queued on {{ $labels.instance }}. Database may be overloaded."

      - alert: MongoDBHighPageFaults
        expr: rate(mongodb_extra_info_page_faults_total[5m]) > 100
        for: 10m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} high page faults"
          description: "{{ $value }} page faults/sec on {{ $labels.instance}}. Working set may not fit in memory."

      - alert: MongoDBSlowReads
        expr: |
          (
            rate(mongodb_ss_opLatencies_latency{type="reads"}[5m]) 
            / 
            rate(mongodb_ss_opLatencies_ops{type="reads"}[5m])
          ) > 50000
        for: 10m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} has slow reads"
          description: "Average read latency is {{ $value | humanize }}μs (>50ms)"

      - alert: MongoDBSlowWrites
        expr: |
          (
            rate(mongodb_ss_opLatencies_latency{type="writes"}[5m]) 
            / 
            rate(mongodb_ss_opLatencies_ops{type="writes"}[5m])
          ) > 50000
        for: 10m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} has slow writes"
          description: "Average write latency is {{ $value | humanize }}μs (>50ms)"
  - name: MongodbAlerts
    interval: 30s
    rules:
      - alert: MongoDBDown
        expr: mongodb_up == 0
        for: 1m
        labels:
          severity: critical
          component: mongodb
          alert_type: availability
        annotations:
          summary: "MongoDB instance {{ $labels.instance }} is down"
          description: "MongoDB instance {{ $labels.instance }} in environment {{ $labels.environment }} has been down for more than 1 minute.\nCurrent value: {{ $value }}"
          dashboard: "https://grafana.example.com/d/mongodb-overview"

      - alert: MongoDBReplicationLagCritical
        expr: mongodb_mongod_replset_member_replication_lag > 30
        for: 5m
        labels:
          severity: critical
          component: mongodb
          alert_type: replication
        annotations:
          summary: "MongoDB replication lag is critical on {{ $labels.instance }}"
          description: "Replication lag is {{ $value }} seconds on {{ $labels.instance }}.\nThis may cause data inconsistency."

      - alert: MongoDBReplicationHeartbeatFailed
        expr: mongodb_mongod_replset_member_health == 0
        for: 2m
        labels:
          severity: critical
          component: mongodb
          alert_type: replication
        annotations:
          summary: "MongoDB replication heartbeat failed on {{ $labels.instance }}"
          description: "Member {{ $labels.name }} in replica set {{ $labels.set }} is not responding to heartbeats."

      - alert: MongoDBNoAvailableConnections
        expr: mongodb_connections{conn_type="available"} < 10
        for: 5m
        labels:
          severity: critical
          component: mongodb
          alert_type: connections
        annotations:
          summary: "MongoDB {{ $labels.instance }} has very few available connections"
          description: "Only {{ $value }} connections available on {{ $labels.instance }}.\nCurrent connections may be exhausted soon."

      - alert: MongoDBCursorTimeouts
        expr: rate(mongodb_ss_metrics_cursor_timed_out_total[5m]) > 10
        for: 5m
        labels:
          severity: critical
          component: mongodb
          alert_type: performance
        annotations:
          summary: "High cursor timeouts on {{ $labels.instance }}"
          description: "{{ $value }} cursor timeouts per second on {{ $labels.instance }}.\nQueries may be taking too long."

      - alert: MongoDBTooManyConnections
        expr: mongodb_connections{conn_type="current"} / mongodb_connections{conn_type="available"} > 0.9
        for: 5m
        labels:
          severity: critical
          component: mongodb
          alert_type: connections
        annotations:
          summary: "MongoDB {{ $labels.instance }} connection usage is critical"
          description: "Connection usage is at {{ $value | humanizePercentage }}.\nCurrent: {{ $labels.current }}, Available: {{ $labels.available }}"

      - alert: MongoDBHighConnections
        expr: mongodb_connections{conn_type="current"} > 1000
        for: 10m
        labels:
          severity: warning
          component: mongodb
          alert_type: connections
        annotations:
          summary: "MongoDB {{ $labels.instance }} has high number of connections"
          description: "Current connections: {{ $value }} on {{ $labels.instance }}"

      - alert: MongoDBConnectionsGrowthRate
        expr: rate(mongodb_connections{conn_type="current"}[15m]) > 10
        for: 10m
        labels:
          severity: warning
          component: mongodb
          alert_type: connections
        annotations:
          summary: "MongoDB {{ $labels.instance }} connections growing rapidly"
          description: "Connections are growing at {{ $value }} per second on {{ $labels.instance }}"

      - alert: MongoDBHighMemoryUsage
        expr: (mongodb_memory{type="resident"} / 1024 / 1024 / 1024) > 8
        for: 10m
        labels:
          severity: warning
          component: mongodb
          alert_type: resources
        annotations:
          summary: "MongoDB {{ $labels.instance }} high memory usage"
          description: "Memory usage is {{ $value | humanize }}GB on {{ $labels.instance }}"

      - alert: MongoDBReplicationLagWarning
        expr: mongodb_mongod_replset_member_replication_lag > 10
        for: 5m
        labels:
          severity: warning
          component: mongodb
          alert_type: replication
        annotations:
          summary: "MongoDB replication lag detected on {{ $labels.instance }}"
          description: "Replication lag is {{ $value }} seconds on {{ $labels.instance }}"

      - alert: MongoDBHighQueryExecutionTime
        expr: rate(mongodb_ss_opLatencies_latency{type="commands"}[5m]) / rate(mongodb_ss_opLatencies_ops{type="commands"}[5m]) > 100000
        for: 10m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} has high query latency"
          description: "Average query latency is {{ $value | humanize }}μs on {{ $labels.instance }}"

      - alert: MongoDBHighTicketUtilization
        expr: mongodb_mongod_wiredtiger_concurrent_transactions_available_tickets{type="read"} < 10
        for: 5m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} has low available read tickets"
          description: "Only {{ $value }} read tickets available on {{ $labels.instance }}.\nThis may cause read contention."

      - alert: MongoDBHighWriteTicketUtilization
        expr: mongodb_mongod_wiredtiger_concurrent_transactions_available_tickets{type="write"} < 10
        for: 5m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} has low available write tickets"
          description: "Only {{ $value }} write tickets available on {{ $labels.instance }}.\nThis may cause write contention."

      - alert: MongoDBUnusualQueryRate
        expr: rate(mongodb_op_counters_total{type="query"}[5m]) > 1000
        for: 15m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} has unusual query rate"
          description: "Query rate is {{ $value }} queries/sec on {{ $labels.instance }}"

      - alert: MongoDBCacheHitRatioLow
        expr: |
          (
            rate(mongodb_mongod_wiredtiger_cache_pages_read_total[5m]) 
            / 
            (rate(mongodb_mongod_wiredtiger_cache_pages_read_total[5m]) + rate(mongodb_mongod_wiredtiger_cache_pages_requested_from_cache_total[5m]))
          ) < 0.9
        for: 10m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} has low cache hit ratio"
          description: "Cache hit ratio is {{ $value | humanizePercentage }} on {{ $labels.instance }}.\nConsider increasing cache size."

      - alert: MongoDBHighDiskUsage
        expr: mongodb_sys_disk_used_percent > 80
        for: 10m
        labels:
          severity: warning
          component: mongodb
          alert_type: resources
        annotations:
          summary: "MongoDB {{ $labels.instance }} disk usage is high"
          description: "Disk usage is {{ $value }}% on {{ $labels.instance }}"

      - alert: MongoDBReplicationMemberStateChanged
        expr: changes(mongodb_mongod_replset_member_state[5m]) > 0
        for: 1m
        labels:
          severity: info
          component: mongodb
          alert_type: replication
        annotations:
          summary: "MongoDB {{ $labels.instance }} replication state changed"
          description: "Member {{ $labels.name }} state changed in replica set {{ $labels.set }}"

      - alert: MongoDBCollectionCount
        expr: mongodb_ss_metrics_document_total > 10000000
        for: 1h
        labels:
          severity: info
          component: mongodb
          alert_type: capacity
        annotations:
          summary: "MongoDB {{ $labels.instance }} has large collection"
          description: "Collection has {{ $value }} documents on {{ $labels.instance }}.\nConsider archiving or sharding."

      - alert: MongoDBSlowQueries
        expr: rate(mongodb_ss_opcounters_total{legacy_op_type="query"}[5m]) / rate(mongodb_ss_opcounters_total[5m]) > 0.5
        for: 10m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} has high ratio of slow queries"
          description: "{{ $value | humanizePercentage }} of queries are slow on {{ $labels.instance }}"

      - alert: MongoDBHighPageFaults
        expr: rate(mongodb_extra_info_page_faults_total[5m]) > 100
        for: 10m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} experiencing high page faults"
          description: "{{ $value }} page faults per second on {{ $labels.instance }}.\nData may not fit in memory."

      - alert: MongoDBQueuedOperations
        expr: mongodb_mongod_global_lock_current_queue{type="total"} > 50
        for: 5m
        labels:
          severity: warning
          component: mongodb
          alert_type: performance
        annotations:
          summary: "MongoDB {{ $labels.instance }} has queued operations"
          description: "{{ $value }} operations are queued on {{ $labels.instance }}"

      - alert: MongoDBReplicaSetNoPrimary
        expr: mongodb_mongod_replset_number_of_members{state="PRIMARY"} == 0
        for: 2m
        labels:
          severity: critical
          component: mongodb
          alert_type: replication
        annotations:
          summary: "MongoDB replica set {{ $labels.set }} has no primary"
          description: "Replica set {{ $labels.set }} has no primary node.\nWrite operations are not possible."

      - alert: MongoDBReplicaSetMemberDown
        expr: mongodb_mongod_replset_member_health == 0
        for: 2m
        labels:
          severity: warning
          component: mongodb
          alert_type: replication
        annotations:
          summary: "MongoDB replica set member {{ $labels.name }} is down"
          description: "Member {{ $labels.name }} in set {{ $labels.set }} is not healthy"

      - alert: MongoDBReplicaSetMemberNotSecondary
        expr: mongodb_mongod_replset_member_state{state!~"PRIMARY|SECONDARY"} == 1
        for: 5m
        labels:
          severity: warning
          component: mongodb
          alert_type: replication
        annotations:
          summary: "MongoDB member {{ $labels.name }} is in abnormal state"
          description: "Member {{ $labels.name }} is in state {{ $labels.state }}"

      - alert: MongoDBAuthenticationFailures
        expr: rate(mongodb_ss_security_authentication_total{result="failed"}[5m]) > 5
        for: 5m
        labels:
          severity: warning
          component: mongodb
          alert_type: security
        annotations:
          summary: "MongoDB {{ $labels.instance }} has authentication failures"
          description: "{{ $value }} authentication failures per second on {{ $labels.instance }}"

      - alert: MongoDBNoBackupRecently
        expr: (time() - mongodb_ss_backgroundFlushing_last_finished) > 86400
        for: 1h
        labels:
          severity: warning
          component: mongodb
          alert_type: backup
        annotations:
          summary: "MongoDB {{ $labels.instance }} backup is overdue"
          description: "Last backup was {{ $value | humanizeDuration }} ago on {{ $labels.instance }}"
