groups:
  - name: Health Checks
    interval: 30s
    rules:
      - alert: ServiceLivenessCheckFailed
        expr: probe_success{job="blackbox-http-liveness"} == 0
        for: 2m
        labels:
          severity: critical
          component: blackbox
          alert_type: availability
        annotations:
          summary: "Service liveness check failed for {{ $labels.service }}"
          description: "Service {{ $labels.instance }} failed liveness probe for 2 minutes. Service may be down or unresponsive."
          dashboard: "blackbox-health"

      - alert: ServiceReadinessCheckFailed
        expr: probe_success{job="blackbox-http-readiness"} == 0
        for: 5m
        labels:
          severity: warning
          component: blackbox
          alert_type: availability
        annotations:
          summary: "Service readiness check failed for {{ $labels.service }}"
          description: "Service {{ $labels.instance }} is not ready to serve traffic for 5 minutes. May indicate dependency issues."
          dashboard: "blackbox-health"

      - alert: ServiceHealthCheckSlow
        expr: probe_duration_seconds{job=~"blackbox-http-.*"} > 2
        for: 5m
        labels:
          severity: warning
          component: blackbox
          alert_type: performance
        annotations:
          summary: "Health check slow for {{ $labels.service }}"
          description: "Health check for {{ $labels.instance }} taking {{ $value | humanizeDuration }} (threshold: 2s). Service may be degraded."
          dashboard: "blackbox-health"

      - alert: ServiceHealthCheckFlapping
        expr: |
          (
            changes(probe_success{job=~"blackbox-http-.*"}[10m]) > 4
          )
        for: 5m
        labels:
          severity: warning
          component: blackbox
          alert_type: stability
        annotations:
          summary: "Health check flapping for {{ $labels.service }}"
          description: "Health check for {{ $labels.instance }} has changed state {{ $value }} times in 10 minutes. Service may be unstable."
          dashboard: "blackbox-health"

      - alert: MultipleServicesDown
        expr: |
          (
            count by (probe_type) (probe_success{job=~"blackbox-http-.*"} == 0) >= 3
          )
        for: 2m
        labels:
          severity: critical
          component: blackbox
          alert_type: availability
        annotations:
          summary: "Multiple services failing {{ $labels.probe_type }} checks"
          description: "{{ $value }} services are failing {{ $labels.probe_type }} checks. Possible infrastructure issue."
          dashboard: "blackbox-health"
