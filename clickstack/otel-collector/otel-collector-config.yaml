extensions:
  health_check:
    endpoint: 0.0.0.0:13133

receivers:
  # docker_stats:
  #   endpoint: tcp://socat:2375
  #   collection_interval: 15s
  
  prometheus:
    config:
      scrape_configs:
        - job_name: 'node-exporter-local'
          scrape_interval: 30s
          static_configs:
            - targets: ['node-exporter:9100']
              labels:
                instance: 'monitoring-server'
                environment: 'production'
        
        - job_name: 'node-exporter'
          scrape_interval: 15s
          file_sd_configs:
            - files:
                - /etc/otel/targets/node.json
        
        - job_name: 'cadvisor'
          scrape_interval: 15s
          file_sd_configs:
            - files:
                - /etc/otel/targets/cadvisor.json
        
        - job_name: 'nginx'
          scrape_interval: 15s
          file_sd_configs:
            - files:
                - /etc/otel/targets/nginx.json
        
        - job_name: 'mongodb'
          scrape_interval: 15s
          file_sd_configs:
            - files:
                - /etc/otel/targets/mongodb.json
        
        - job_name: 'postgres'
          scrape_interval: 15s
          file_sd_configs:
            - files:
                - /etc/otel/targets/postgres.json
        
        - job_name: 'blackbox-http-liveness'
          scrape_interval: 15s
          metrics_path: /probe
          params:
            module: [http_liveness]
          file_sd_configs:
            - files:
                - /etc/otel/targets/blackbox-liveness.json
          relabel_configs:
            - source_labels: [__address__]
              target_label: __param_target
            - source_labels: [__param_target]
              target_label: instance
            - source_labels: [__param_target]
              regex: 'http://([^:]+):.*'
              target_label: service
              replacement: '$1'
            - target_label: __address__
              replacement: blackbox-exporter:9115
        
        - job_name: 'blackbox-http-readiness'
          scrape_interval: 15s
          metrics_path: /probe
          params:
            module: [http_readiness]
          file_sd_configs:
            - files:
                - /etc/otel/targets/blackbox-readiness.json
          relabel_configs:
            - source_labels: [__address__]
              target_label: __param_target
            - source_labels: [__param_target]
              target_label: instance
            - source_labels: [__param_target]
              regex: 'http://([^:]+):.*'
              target_label: service
              replacement: '$1'
            - target_label: __address__
              replacement: blackbox-exporter:9115
  
  filelog:
    include:
      - /var/lib/docker/containers/*/*.log
    include_file_path: true
    include_file_name: false
    operators:
      - type: json_parser
        id: parser-docker
        timestamp:
          parse_from: attributes.time
          layout: '%Y-%m-%dT%H:%M:%S.%LZ'
      
      - type: move
        from: attributes.log
        to: body
      
      - type: regex_parser
        regex: '^/var/lib/docker/containers/(?P<container_id>[^/]+)/.*\.log$'
        parse_from: attributes["log.file.path"]
      
      - type: add
        field: resource["container.id"]
        value: EXPR(attributes["container_id"])

processors:
  batch:
    timeout: 5s
    send_batch_size: 1000
    send_batch_max_size: 2000
  
  memory_limiter:
    check_interval: 1s
    limit_mib: 3500
    spike_limit_mib: 512
  
  resourcedetection:
    detectors: [env, system]
    timeout: 5s
    override: false
  
  attributes:
    actions:
      - key: deployment.environment
        value: production
        action: insert
  
  transform/logs:
    log_statements:
      - context: log
        statements:
          - set(resource.attributes["service.name"], resource.attributes["container.name"]) where resource.attributes["service.name"] == nil
          - set(resource.attributes["service.name"], "unknown_service") where resource.attributes["service.name"] == ""
          - set(severity_text, "INFO") where severity_text == nil
          - set(resource.attributes["job"], "docker")
  
  filter/drop_old_logs:
    logs:
      log_record:
        - 'time_unix_nano < (Now() - Duration("24h"))'
  
  filter/drop_corrupted_logs:
    logs:
      log_record:
        - 'IsMatch(body, ".*[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F].*")'

exporters:
  otlp/hdx:
    endpoint: 'localhost:4317'
    tls:
      insecure: true
    headers:
      authorization: d97f7dae-fd67-421f-b06d-7b1f2934442e
  
  debug:
    verbosity: basic

service:
  extensions: [health_check]
  
  pipelines:
    metrics:
      receivers: [prometheus]
      processors: [memory_limiter, resourcedetection, attributes, batch]
      exporters: [otlp/hdx]
    
    # logs:
    #   receivers: [filelog]
    #   processors: [memory_limiter, resourcedetection, transform/logs, filter/drop_corrupted_logs, filter/drop_old_logs, attributes, batch]
    #   exporters: [otlp/hdx]
  
  telemetry:
    logs:
      level: info
